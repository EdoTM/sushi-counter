stages:
  - test
  - build
  - deploy

test-backend:
  tags: ["docker"]
  image: amazoncorretto:21-alpine
  stage: test
  script:
    - echo $CI_PROJECT_PATH && exit 1
    - cd backend
    - mv /cache/$CI_PROJECT_NAME/.gradle . || echo ""
    - ./gradlew test

build-backend:
  tags: ["docker"]
  image: amazoncorretto:21-alpine
  stage: build
  script:
    - cd backend
    - ./gradlew build
    - mv .gradle /cache/$CI_PROJECT_NAME
    - mv build/libs/backend-all.jar ./backend.jar
    - mv .gradle/ /cache/$CI_PROJECT_NAME/

build-frontend:
  tags: ["docker"]
  image: node:alpine
  stage: build
  script:
    - cd frontend
    - npm install
    - npm run build

deploy-backend:
  tags: ["docker"]
  stage: deploy
  image: docker 
  script:
    - echo "Deploying backend..."
    - cd $COMMON_SERVICES/sushi-counter
    - docker compose down
    - mv backend/backend.jar $COMMON_SERVICES/sushi-counter
    - rm -f backend.jar
    - ls
    - file backend.jar
    - docker compose up -d

deploy-frontend:
  tags: ["docker"]
  stage: deploy
  script:
    - echo "Deploying frontend..."
    - cd $COMMON_WWW
    - rm -rf sushi-counter/
    - mv /cache/dist ./sushi-counter
